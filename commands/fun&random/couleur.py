# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“Œ couleur.py â€” Commande interactive !couleur et /couleur
# Objectif : Afficher une couleur alÃ©atoire avec ses codes HEX et RGB dans un embed Discord
# CatÃ©gorie : ğŸ¨ Fun&Random
# AccÃ¨s : Public
# Cooldown : 1 utilisation / 3 sec / utilisateur
# Version : âœ… OptimisÃ©e + intÃ¨gre la quÃªte "couleur"
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ Imports nÃ©cessaires
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import random
import discord
from discord import app_commands
from discord.ext import commands
from utils.discord_utils import safe_send, safe_edit, safe_respond, safe_interact
from utils.supabase_client import supabase  # âœ… pour accÃ©der Ã  la base

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ›ï¸ Vue interactive avec bouton "Nouvelle couleur"
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class CouleurView(discord.ui.View):
    def __init__(self, author: discord.User | discord.Member):
        super().__init__(timeout=60)
        self.author = author
        self.message: discord.Message | None = None

    def generer_embed(self) -> discord.Embed:
        code_hex = random.randint(0, 0xFFFFFF)
        hex_str = f"#{code_hex:06X}"
        r, g, b = (code_hex >> 16) & 0xFF, (code_hex >> 8) & 0xFF, code_hex & 0xFF
        rgb_str = f"({r}, {g}, {b})"

        embed = discord.Embed(
            title="ğŸŒˆ Couleur alÃ©atoire",
            description=f"ğŸ”¹ **Code HEX** : `{hex_str}`\nğŸ”¸ **Code RGB** : `{rgb_str}`",
            color=code_hex
        )
        embed.set_image(url=f"https://dummyimage.com/700x200/{code_hex:06x}/{code_hex:06x}.png&text=+")
        return embed

    @discord.ui.button(label="ğŸ” Nouvelle couleur", style=discord.ButtonStyle.primary)
    async def regenerate(self, interaction: discord.Interaction, button: discord.ui.Button):
        if interaction.user != self.author:
            return await safe_interact(interaction, content="âŒ Tu ne peux pas utiliser ce bouton.", ephemeral=True)

        new_embed = self.generer_embed()
        await safe_interact(interaction, edit=True, embed=new_embed, view=self)

    async def on_timeout(self):
        for child in self.children:
            child.disabled = True
        if self.message:
            try:
                await safe_edit(self.message, view=self)
            except Exception:
                pass

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§  Cog principal
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class CouleurCommand(commands.Cog):
    """Commande !couleur et /couleur â€” GÃ©nÃ¨re et affiche une couleur alÃ©atoire avec codes HEX et RGB."""
    def __init__(self, bot: commands.Bot):
        self.bot = bot

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # âš™ï¸ Fonction interne pour valider la quÃªte "couleur"
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async def valider_quete_couleur(
        self, 
        user: discord.User, 
        channel: discord.abc.Messageable | None = None, 
        interaction: discord.Interaction | None = None
    ):
        try:
            data = supabase.table("reiatsu").select("quetes, niveau").eq("user_id", user.id).execute()
            if not data.data:
                return  # Aucun profil trouvÃ©

            quetes = data.data[0].get("quetes", [])
            niveau = data.data[0].get("niveau", 1)

            # Si la quÃªte est dÃ©jÃ  faite, rien Ã  faire
            if "couleur" in quetes:
                return

            # Ajoute la quÃªte et augmente le niveau
            quetes.append("couleur")
            new_lvl = niveau + 1
            supabase.table("reiatsu").update({"quetes": quetes, "niveau": new_lvl}).eq("user_id", user.id).execute()

            # âœ… Embed de fÃ©licitations
            embed = discord.Embed(
                title="ğŸ‰ QuÃªte accomplie !",
                description=f"Bravo **{user.name}** ! Tu as terminÃ© la quÃªte **Couleur** ğŸ†\n\nâ­ **Niveau +1 !** (Niveau {new_lvl})",
                color=0x00FF7F
            )

            # Envoi dans le salon appropriÃ©
            if interaction:
                if channel:
                    await safe_send(channel, embed=embed)
                else:
                    if not interaction.response.is_done():
                        await interaction.response.send_message(embed=embed)
                    else:
                        await interaction.followup.send(embed=embed)
            elif channel:
                await safe_send(channel, embed=embed)
            else:
                # fallback au MP
                await safe_send(user, embed=embed)

        except Exception as e:
            print(f"[ERREUR validation quÃªte couleur] {e}")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Commande SLASH
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @app_commands.command(
        name="couleur",
        description="Affiche une couleur alÃ©atoire avec un aperÃ§u visuel et ses codes HEX & RGB."
    )
    @app_commands.checks.cooldown(1, 3.0, key=lambda i: (i.user.id))
    async def slash_couleur(self, interaction: discord.Interaction):
        try:
            view = CouleurView(interaction.user)
            embed = view.generer_embed()

            await safe_interact(interaction, embed=embed, view=view)
            view.message = await interaction.original_response()

            # âœ… Validation de la quÃªte dans le salon
            await self.valider_quete_couleur(interaction.user, channel=interaction.channel, interaction=interaction)

        except Exception as e:
            print(f"[ERREUR /couleur] {e}")
            await safe_respond(interaction, content="âŒ Une erreur est survenue lors de la gÃ©nÃ©ration de la couleur.", ephemeral=True)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Commande PREFIX
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @commands.command(
        name="couleur",
        help="ğŸ¨ Affiche une couleur alÃ©atoire avec ses codes HEX et RGB.",
        description="Affiche une couleur alÃ©atoire avec un aperÃ§u visuel et ses codes HEX & RGB."
    )
    @commands.cooldown(rate=1, per=3, type=commands.BucketType.user)
    async def prefix_couleur(self, ctx: commands.Context):
        try:
            view = CouleurView(ctx.author)
            embed = view.generer_embed()
            view.message = await safe_send(ctx, embed=embed, view=view)

            # âœ… Validation de la quÃªte dans le salon
            await self.valider_quete_couleur(ctx.author, channel=ctx.channel)

        except Exception as e:
            print(f"[ERREUR !couleur] {e}")
            await safe_send(ctx, "âŒ Une erreur est survenue lors de la gÃ©nÃ©ration de la couleur.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”Œ Setup du Cog
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def setup(bot: commands.Bot):
    cog = CouleurCommand(bot)
    for command in cog.get_commands():
        if not hasattr(command, "category"):
            command.category = "Fun&Random"
    await bot.add_cog(cog)
