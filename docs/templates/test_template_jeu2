# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“Œ nom_du_jeu.py â€” Commande interactive /nom_du_jeu et !nom_du_jeu
# Objectif : Description courte du jeu avec embed interactif, mode solo/multi et timer
# CatÃ©gorie : Jeux
# AccÃ¨s : Tous
# Cooldown : 1 utilisation / 5 secondes / utilisateur
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“¦ Imports nÃ©cessaires
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import discord
from discord import app_commands
from discord.ext import commands
import asyncio
from utils.discord_utils import safe_send, safe_edit, safe_respond

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ® Classe principale du jeu
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class NomDuJeuView:
    """Classe reprÃ©sentant une partie de NomDuJeu"""

    def __init__(self, author_id: int | None = None, multi: bool = False):
        self.author_id = author_id
        self.multi = multi
        self.finished = False
        self.start_time = asyncio.get_event_loop().time()
        self.message: discord.Message | None = None
        self.attempts: list[dict] = []  # {'author': str, 'word': str}

    def build_embed(self) -> discord.Embed:
        """Construit lâ€™embed avec instructions et essais"""
        mode_text = "Solo ğŸ§â€â™‚ï¸" if not self.multi else "Multi ğŸŒ"
        embed = discord.Embed(
            title=f"ğŸ® NomDuJeu - {mode_text}",
            description="ğŸ’¡ **Instructions du jeu :**\n1ï¸âƒ£ Mode solo : seul le lanceur peut jouer.\n2ï¸âƒ£ Mode multi : tout le monde peut jouer.\n3ï¸âƒ£ Faites vos propositions avec `.` ou `*` suivi de votre essai.\n4ï¸âƒ£ La partie se termine automatiquement aprÃ¨s 3 minutes ou quand le jeu est terminÃ©.",
            color=discord.Color.orange()
        )

        if self.attempts:
            lines = [f"{entry['author']} â†’ {entry['word']}" for entry in self.attempts]
            embed.add_field(name=f"Essais ({len(self.attempts)})", value="\n".join(lines), inline=False)
        else:
            embed.add_field(name="Essais", value="*(Aucun essai pour lâ€™instant)*", inline=False)

        if self.finished:
            embed.color = discord.Color.green()
            embed.set_footer(text="ğŸ‰ Partie terminÃ©e !")
        else:
            elapsed = int(asyncio.get_event_loop().time() - self.start_time)
            remaining = max(0, 180 - elapsed)
            embed.set_footer(text=f"â³ Temps restant : {remaining} secondes")

        return embed

    async def process_guess(self, channel: discord.abc.Messageable, guess: str, author_name: str, author_id: int):
        """Traite une proposition"""
        if self.finished:
            return await safe_send(channel, "âš ï¸ La partie est terminÃ©e.")
        if not self.multi and author_id != self.author_id:
            return
        self.attempts.append({'author': author_name, 'word': guess})
        if self.message:
            await safe_edit(self.message, embed=self.build_embed())

    async def check_timeout(self):
        """ArrÃªte la partie aprÃ¨s 3 minutes"""
        while not self.finished:
            await asyncio.sleep(5)
            elapsed = asyncio.get_event_loop().time() - self.start_time
            if elapsed >= 180:
                self.finished = True
                if self.message:
                    await safe_edit(self.message, embed=self.build_embed())
                break

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§  Cog principal
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class NomDuJeu(commands.Cog):
    """Commande /nom_du_jeu et !nom_du_jeu â€” Description courte"""

    def __init__(self, bot: commands.Bot):
        self.bot = bot
        self.active_games: dict[int, NomDuJeuView] = {}  # guild_id -> vue active

    async def _start_game(self, channel: discord.abc.Messageable, author_id: int, guild_id: int, mode: str = "solo"):

        # VÃ©rifie s'il y a dÃ©jÃ  une partie active sur le serveur
        if guild_id in self.active_games and not self.active_games[guild_id].finished:
            return await safe_respond(channel, "âš ï¸ Une partie est dÃ©jÃ  en cours sur ce serveur !", ephemeral=True)

        multi = mode.lower() in ("multi", "m")
        view = NomDuJeuView(author_id=None if multi else author_id, multi=multi)
        embed = view.build_embed()
        view.message = await safe_send(channel, embed=embed)
        self.active_games[guild_id] = view
        asyncio.create_task(view.check_timeout())

    @commands.Cog.listener()
    async def on_message(self, message: discord.Message):
        if message.author.bot:
            return
        guild_id = message.guild.id if message.guild else None
        if guild_id not in self.active_games:
            return
        content = message.content.strip()
        if content.startswith((".", "*")):
            view = self.active_games[guild_id]
            await view.process_guess(message.channel, content, message.author.display_name, message.author.id)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Commande SLASH
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @app_commands.command(name="nom_du_jeu", description="Lance le jeu NomDuJeu (solo ou multi)")
    @app_commands.describe(mode="Mode de jeu : solo ou multi (m)")
    async def slash_nom_du_jeu(self, interaction: discord.Interaction, mode: str = "solo"):
        await interaction.response.defer()
        await self._start_game(interaction.channel, author_id=interaction.user.id, guild_id=interaction.guild.id, mode=mode)
        await interaction.delete_original_response()

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ğŸ”¹ Commande PREFIX
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    @commands.command(name="nom_du_jeu", help="Lance le jeu NomDuJeu. Utilisez 'multi' ou 'm' pour jouer Ã  plusieurs.")
    async def prefix_nom_du_jeu(self, ctx: commands.Context, mode: str = "solo"):
        await self._start_game(ctx.channel, author_id=ctx.author.id, guild_id=ctx.guild.id, mode=mode)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”Œ Setup du Cog
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def setup(bot: commands.Bot):
    cog = NomDuJeu(bot)
    for command in cog.get_commands():
        if not hasattr(command, "category"):
            command.category = "Jeux"
    await bot.add_cog(cog)
